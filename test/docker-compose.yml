version: '3.9'

services:
  cdk-l1:
    container_name: cdk-l1
    image: 0xpolygon/cdk-validium-contracts:forkId8
    ports:
      - '8545:8545'
      - '8546:8546'
    command:
      - "--http"
      - "--http.api"
      - "admin,eth,debug,miner,net,txpool,personal,web3"
      - "--http.addr"
      - "0.0.0.0"
      - "--http.corsdomain"
      - "*"
      - "--http.vhosts"
      - "*"
      - "--ws"
      - "--ws.origins"
      - "*"
      - "--ws.addr"
      - "0.0.0.0"
      - "--dev"
      - "--dev.period"
      - "1"
      - "--datadir"
      - "/geth_data"
      - "--syncmode"
      - "full"
      - "--rpc.allow-unprotected-txs"
    networks:
      - cdk-localnet

  cdk-postgres:
    container_name: cdk-postgres
    image: postgres
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    ports:
      - 5432:5432
    volumes:
      # This script will create the folowing DBs: prover_db_1, pool_db_1, bridge_db_1, prover_db_2 state_db_2, pool_db_2, bridge_db_2
      # It will also create the schema for prover_db_* DBs
      - ./config/init_dbs.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready", "-d", "prover_db" ]
      interval: 30s
      timeout: 60s
      retries: 5
      start_period: 10s
    command: ["postgres", "-N", "500"]
    networks:
      - cdk-localnet

  cdk-prover-1:
    container_name: cdk-prover-1
    platform: linux/amd64
    image: hermeznetwork/zkevm-prover:v6.0.0
    ports:
      - 50061:50061 # MT
      - 50071:50071 # Executor
    volumes:
      - ./config/prover/prover-1.json:/usr/src/app/config.json
    command: >
      zkProver -c /usr/src/app/config.json
    depends_on:
      cdk-postgres:
        condition: service_healthy
    environment:
      EXPERIMENTAL_DOCKER_DESKTOP_FORCE_QEMU: 1
    networks:
      - cdk-localnet

  cdk-validium-node-1:
    container_name: cdk-validium-node-1
    image: 0xpolygon/cdk-validium-node:0.6.4-cdk.6
    volumes:
      - ./config/node/sequencer-1.keystore:/pk/sequencer.keystore
      - ./config/node/aggregator-1.keystore:/pk/aggregator.keystore
      - ./config/node/cdk-validium-node-1.toml:/app/config.toml
      - ./config/node/genesis-1.json:/app/genesis.json
    command: 
      - "/bin/sh"
      - "-c"
      - "/app/zkevm-node approve --network custom --custom-network-file /app/genesis.json --am 115792089237316195423570985008687907853269984665640564039457584007913129639935 -y --cfg /app/config.toml --key-store-path /pk/sequencer.keystore --password testonly &&
         /app/zkevm-node run --network custom --custom-network-file /app/genesis.json --cfg /app/config.toml --components \"synchronizer,sequencer,aggregator,eth-tx-manager,l2gaspricer\""
    depends_on:
      cdk-postgres:
        condition: service_healthy
      cdk-prover-1:
        condition: service_started
      cdk-l1:
        condition: service_started
    networks:
      - cdk-localnet

  cdk-validium-hermez-sequence-sender-1:
    container_name: cdk-sequence-sender
    image: 0xpolygon/cdk-validium-node:0.6.4-cdk.6
    restart: unless-stopped
    volumes:
      - ./config/node/sequencer-1.keystore:/pk/sequencer.keystore
      - ./config/node/cdk-validium-node-1.toml:/app/config.toml
      - ./config/node/genesis-1.json:/app/genesis.json
    command: 
      - "/bin/sh"
      - "-c"
      - "/app/zkevm-node run --network custom --custom-network-file /app/genesis.json --cfg /app/config.toml --components \"sequence-sender\""
    depends_on:
      cdk-validium-node-1:
        condition: service_started
    networks:
      - cdk-localnet

  cdk-validium-cdk-sequence-sender-1:
    container_name: cdk-sequence-sender
    image: 0xpolygon/cdk-sequence-sender:test
    restart: unless-stopped
    volumes:
      - ./config/node/sequencer-1.keystore:/pk/sequencer.keystore
      - ./config/node/cdk-validium-cdk-sequence-sender-1.toml:/app/config.toml
      - ./config/node/genesis-1.json:/app/genesis.json
    command: 
      - "/bin/sh"
      - "-c"
      - "/app/zkevm-seqsender run --network custom --custom-network-file /app/genesis.json --cfg /app/config.toml --components \"sequence-sender\""
    depends_on:
      cdk-validium-node-1:
        condition: service_started
    networks:
      - cdk-localnet

  cdk-validium-hermez-rpc-1:
    container_name: cdk-validium-hermez-rpc-1
    image: 0xpolygon/cdk-validium-node:0.6.4-cdk.6
    restart: unless-stopped
    ports:
      - 8123:8123
    volumes:
      - ./config/node/cdk-validium-node-1.toml:/app/config.toml
      - ./config/node/genesis-1.json:/app/genesis.json
    command: 
      - "/bin/sh"
      - "-c"
      - "/app/zkevm-node run --network custom --custom-network-file /app/genesis.json --cfg /app/config.toml --components \"rpc\" --http.api eth,net,debug,zkevm,txpool,web3"
    depends_on:
      cdk-validium-node-1:
        condition: service_started
    networks:
      - cdk-localnet

  # TODO: add cdk-validium-erigon-rpc-1
  # TODO: add cdk-validium-hermez-sequencer-1
  # TODO: add cdk-validium-erigon-sequencer-1

  cdk-validium-hermez-aggregator-direct-1:
    container_name: cdk-aggregator
    image: 0xpolygon/cdk-validium-node:0.6.4-cdk.6
    restart: unless-stopped
    volumes:
      - ./config/node/sequencer-1.keystore:/pk/sequencer.keystore
      - ./config/node/aggregator-1.keystore:/pk/aggregator.keystore
      - ./config/node/cdk-validium-hermez-aggregator-direct-1.toml:/app/config.toml
      - ./config/node/genesis-1.json:/app/genesis.json
    command: 
      - "/bin/sh"
      - "-c"
      - "/app/zkevm-node run --network custom --custom-network-file /app/genesis.json --cfg /app/config.toml --components \"aggregator\""
    depends_on:
      cdk-validium-node-1:
        condition: service_started
    networks:
      - cdk-localnet

  cdk-validium-hermez-aggregator-agglayer-1:
    container_name: cdk-aggregator
    image: 0xpolygon/cdk-validium-node:0.6.4-cdk.6
    volumes:
      - ./config/node/sequencer-1.keystore:/pk/sequencer.keystore
      - ./config/node/aggregator-1.keystore:/pk/aggregator.keystore
      - ./config/node/cdk-validium-hermez-aggregator-agglayer-1.toml:/app/config.toml
      - ./config/node/genesis-1.json:/app/genesis.json
    command: 
      - "/bin/sh"
      - "-c"
      - "/app/zkevm-node run --network custom --custom-network-file /app/genesis.json --cfg /app/config.toml --components \"aggregator\""
    depends_on:
      cdk-validium-node-1:
        condition: service_started
    networks:
      - cdk-localnet


networks:
  cdk-localnet:
    driver: bridge
